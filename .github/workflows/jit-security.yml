name: Workflows generated by the MVS plan
on:
  workflow_dispatch:
    inputs:
       client_payload:
          description: The Client payload
          required: true

permissions:
  contents: read
  id-token: write

jobs:
  enrich:
    if: fromJSON(github.event.inputs.client_payload).payload.workflow_job_name == 'enrich' && fromJSON(github.event.inputs.client_payload).payload.workflow_slug == 'workflow-enrichment-code'
    runs-on: ubuntu-20.04
    timeout-minutes: 20
    steps:
    - name: enrichment
      uses: jitsecurity-controls/jit-github-action@v3.0.1
      with:
        security_control: registry.jit.io/control-enrichment-slim:latest
        context: ${{toJSON(fromJSON(github.event.inputs.client_payload).context)}}
        runner_setup: ${{toJSON(fromJSON(github.event.inputs.client_payload).context.job.runner.setup)}}
        
  remediation-pr:
    if: fromJSON(github.event.inputs.client_payload).payload.workflow_job_name == 'remediation-pr' && fromJSON(github.event.inputs.client_payload).payload.workflow_slug == 'workflow-remediation-pr'
    runs-on: ubuntu-20.04
    timeout-minutes: 20
    steps:
    - name: remediation-pr
      uses: jitsecurity-controls/jit-github-action@v3.0.1
      with:
        security_control: registry.jit.io/open-remediation-pr-alpine:latest
        security_control_output_file: /opt/code/jit-report/results.json
        context: ${{toJSON(fromJSON(github.event.inputs.client_payload).context)}}
        runner_setup: ${{toJSON(fromJSON(github.event.inputs.client_payload).context.job.runner.setup)}}
        inline_environment: -e GITHUB_TOKEN="${{fromJSON(github.event.inputs.client_payload).payload.github_token}}"
        
  secret-detection:
    if: fromJSON(github.event.inputs.client_payload).payload.workflow_job_name == 'secret-detection' && fromJSON(github.event.inputs.client_payload).payload.workflow_slug == 'workflow-secret-detection'
    runs-on: ubuntu-20.04
    timeout-minutes: 20
    steps:
    - name: gitleaks
      uses: jitsecurity-controls/jit-github-action@v3.0.1
      with:
        security_control: registry.jit.io/control-gitleaks-alpine:latest
        security_control_output_file: /tmp/report.json
        context: ${{toJSON(fromJSON(github.event.inputs.client_payload).context)}}
        runner_setup: ${{toJSON(fromJSON(github.event.inputs.client_payload).context.job.runner.setup)}}
        
  software-component-analysis-php:
    if: fromJSON(github.event.inputs.client_payload).payload.workflow_job_name == 'software-component-analysis-php' && fromJSON(github.event.inputs.client_payload).payload.workflow_slug == 'workflow-sca'
    runs-on: ubuntu-20.04
    timeout-minutes: 20
    steps:
    - name: osv-scanner
      uses: jitsecurity-controls/jit-github-action@v3.0.1
      with:
        security_control: registry.jit.io/control-osv-scanner-alpine:latest
        security_control_output_file: /code/jit-report/osv-scanner-results.json
        context: ${{toJSON(fromJSON(github.event.inputs.client_payload).context)}}
        runner_setup: ${{toJSON(fromJSON(github.event.inputs.client_payload).context.job.runner.setup)}}
        
  software-component-analysis-python:
    if: fromJSON(github.event.inputs.client_payload).payload.workflow_job_name == 'software-component-analysis-python' && fromJSON(github.event.inputs.client_payload).payload.workflow_slug == 'workflow-sca'
    runs-on: ubuntu-20.04
    timeout-minutes: 20
    steps:
    - name: osv-scanner
      uses: jitsecurity-controls/jit-github-action@v3.0.1
      with:
        security_control: registry.jit.io/control-osv-scanner-alpine:latest
        security_control_output_file: /code/jit-report/enriched-osv-scanner-results.json
        context: ${{toJSON(fromJSON(github.event.inputs.client_payload).context)}}
        runner_setup: ${{toJSON(fromJSON(github.event.inputs.client_payload).context.job.runner.setup)}}
        
  software-component-analysis-snyk:
    if: fromJSON(github.event.inputs.client_payload).payload.workflow_job_name == 'software-component-analysis-snyk' && fromJSON(github.event.inputs.client_payload).payload.workflow_slug == 'workflow-sca'
    runs-on: ubuntu-20.04
    timeout-minutes: 20
    steps:
    - name: snyk
      uses: jitsecurity-controls/jit-github-action@v3.0.1
      with:
        security_control: ghcr.io/jitsecurity-controls/control-snyk-alpine:latest
        context: ${{toJSON(fromJSON(github.event.inputs.client_payload).context)}}
        runner_setup: ${{toJSON(fromJSON(github.event.inputs.client_payload).context.job.runner.setup)}}
        
  static-code-analysis-php:
    if: fromJSON(github.event.inputs.client_payload).payload.workflow_job_name == 'static-code-analysis-php' && fromJSON(github.event.inputs.client_payload).payload.workflow_slug == 'workflow-sast'
    runs-on: ubuntu-20.04
    timeout-minutes: 20
    steps:
    - name: semgrep
      uses: jitsecurity-controls/jit-github-action@v3.0.1
      with:
        security_control: registry.jit.io/control-semgrep-alpine:latest
        context: ${{toJSON(fromJSON(github.event.inputs.client_payload).context)}}
        runner_setup: ${{toJSON(fromJSON(github.event.inputs.client_payload).context.job.runner.setup)}}
        
  static-code-analysis-snyk:
    if: fromJSON(github.event.inputs.client_payload).payload.workflow_job_name == 'static-code-analysis-snyk' && fromJSON(github.event.inputs.client_payload).payload.workflow_slug == 'workflow-sast'
    runs-on: ubuntu-20.04
    timeout-minutes: 20
    steps:
    - name: snyk
      uses: jitsecurity-controls/jit-github-action@v3.0.1
      with:
        security_control: ghcr.io/jitsecurity-controls/control-snyk-alpine:latest
        context: ${{toJSON(fromJSON(github.event.inputs.client_payload).context)}}
        runner_setup: ${{toJSON(fromJSON(github.event.inputs.client_payload).context.job.runner.setup)}}
        